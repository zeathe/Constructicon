<?xml version="1.0" encoding="ISO-8859-1" ?>
<project name="Constructicon" basedir=".." default="compile.dist">
	<!-- 
	Build System Setup:

	We're assuming the environment variable BSLandingZone is present.
	This represents the location on disk that we'll be pushing compile
	output bits to... and building our package structures into.

	The following variables are of interest...

	**** $(BSLandingZone) 	>>>> ${output.root} (sorta)
	**** ${basedir} 	>>>> ${proj.root}

	${output.root}		=	Where Compile Output goes
	${logging.root}		=	Where the Log Output goes
	${proj.root}		=	Base directory of Sources
	${src.root}		=	Where .m, .h, and .pch should be
	${nib.root}		=	Where .xib and .nib files should exist
					in a localized state (IE English.lproj)
	${BuildSystem.root}	=	Location for shared BuildSystem files
					as expected to be.

	This is a sub-project XML file.  It wil receive all of the above
	variables through inheritence.

	-->

	<target name="package.debug">
		<echo message="Setting DEBUG Obj Root" />
		<property name="obj.root.debug" value="${obj.root}/debug" />
		<echo message="Staging Debug DMG Template" />
		<copy file="${proj.root}/BUILD/mac.DMG/Constructicon.Template.dmg.sparseimage" tofile="${obj.root}/Constructicon.debug.dmg.sparsefile" />
		<echo message="Making DEBUGDMG Mountpoint" />
		<mkdir dir="${obj.root}/DEBUGDMG" />
		<echo message="Resizing DEBUG Template" />
		<exec executable="chown">
			<arg value=":staff" />
			<arg value="${obj.root}/Constructicon.debug.dmg.sparsefile" />
		</exec>
		<exec executable="hdiutil">
			<arg value="resize" />
			<arg value="-size" />
			<arg value="600M" />
			<arg value="${obj.root}/Constructicon.debug.dmg.sparsefile" />
		</exec>
		<exec executable="hdiutil">
			<arg value="attach" />
			<arg value="${obj.root}/Constructicon.debug.dmg.sparsefile" />
			<arg value="-mountpoint" />
			<arg value="${obj.root}/DEBUGDMG" />
			<arg value="-nobrowse" />
		</exec>
		<waitfor maxwait="30" maxwaitunit="second">
			<available file="${obj.root}/DEBUGDMG" />
		</waitfor>
		<copy todir="${obj.root}/DEBUGDMG/Constructicon">
			<fileset dir="${proj.root}">
				<exclude name="BUILD/**" />
				<exclude name=".git/**" />
				<exclude name=".gitignore" />
				<exclude name="build.xml" />
				<exclude name=".constructicon.maintenance" />
			</fileset>
		</copy>
		<exec executable="diskutil">
			<arg value="renameVolume" />
			<arg value="${obj.root}/DEBUGDMG" />
			<arg value="Constructicon v${env.constructicon.majorversion}.${env.constructicon.minorversion}.${env.constructicon.maintenanceversion}.${env.constructicon.buildid} DEBUG" />
		</exec>
		<exec executable="hdiutil">
			<arg value="eject" />
			<arg value="${obj.root}/DEBUGDMG" />
		</exec>
		<exec executable="hdiutil">
			<arg value="compact" />
			<arg value="${obj.root}/Constructicon.debug.dmg.sparsefile" />
		</exec>
		<exec executable="hdiutil">
			<arg value="convert" />
			<arg value="${obj.root}/Constructicon.debug.dmg.sparsefile" />
			<arg value="-format" />
			<arg value="UDBZ" />
			<arg value="-o" />
			<arg value="${output.root}/Constructicon.debug.dmg" />
		</exec>
	</target>

	<target name="compile.debug">
		<antcall target="package.debug" />
	</target>

	<target name="package.dist">
		<property name="obj.root.dist" value="${obj.root}/dist" />
		<copy file="${proj.root}/BUILD/mac.DMG/Constructicon.Template.dmg.sparseimage" tofile="${obj.root}/Constructicon.dmg.sparsefile" />
		<mkdir dir="${obj.root}/DISTDMG" />
		<exec executable="chown">
			<arg value=":staff" />
			<arg value="${obj.root}/Constructicon.dmg.sparsefile" />
		</exec>
		<exec executable="hdiutil">
			<arg value="resize" />
			<arg value="-size" />
			<arg value="600M" />
			<arg value="${obj.root}/Constructicon.dmg.sparsefile" />
		</exec> 
		<exec executable="hdiutil">
			<arg value="attach" />
			<arg value="${obj.root}/Constructicon.dmg.sparsefile" />
			<arg value="-mountpoint" />
			<arg value="${obj.root}/DISTDMG" />
			<arg value="-nobrowse" />
		</exec>
		<waitfor maxwait="30" maxwaitunit="second">
			<available file="${obj.root}/DISTDMG" />
		</waitfor>
		<copy todir="${output.root}/DISTDMG/Constructicon">
			<fileset dir="${proj.root}">
				<exclude name="BUILD/**" />
				<exclude name=".git/**" />
				<exclude name=".gitignore" />
				<exclude name="build.xml" />
				<exclude name=".constructicon.maintenance" />
			</fileset>
		</copy>
		<exec executable="diskutil">
			<arg value="renameVolume" />
			<arg value="${obj.root}/DISTDMG" />
			<arg value='"Constructicon v${env.constructicon.majorversion}.${env.constructicon.minorversion}.${env.constructicon.maintenanceversion}.${env.constructicon.buildid}"' />
		</exec>
		<exec executable="hdiutil">
			<arg value="eject" />
			<arg value="${obj.root}/DISTDMG" />
		</exec>
		<exec executable="hdiutil">
			<arg value="compact" />
			<arg value="${obj.root}/Constructicon.dmg.sparsefile" />
		</exec>
		<exec executable="hdiutil">
			<arg value="convert" />
			<arg value="${obj.root}/Constructicon.dmg.sparsefile" />
			<arg value="-format" />
			<arg value="UDBZ" />
			<arg value="-o" />
			<arg value="${output.root}/Constructicon.dmg" />
		</exec>
	</target>

	<target name="compile.dist">
		<antcall target="package.dist" />
	</target>

</project>
